<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¼æ²¹è£…ç½®è…èš€è¯„ä»·ä¸“å®¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>


<body>
    <!-- ĞĞ°Ñˆ Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="logo-text">ç‚¼æ²¹è£…ç½®è…èš€è¯„ä»·ä¸“å®¶ç³»ç»Ÿ</div>
        </div>
            <div class="search-container">
                <input type="text" class="search-box" placeholder="æœç´¢">
            </div>

        <div class="menu-item active" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <i class="fas fa-industry"></i>
                <span>ç‚¼æ²¹è£…ç½®ç®¡ç†</span>
            </div>
            <a href="#" title="æ·»åŠ æ–°è®¾å¤‡" onclick="openDeviceInlineForm(); return false;">
                <i class="fas fa-circle-plus" data-toggle="device" style="font-size: 18px; color: #4CAF50; margin-right: 10px;"></i>
            </a>
         </div>


        <!-- Ğ˜Ğ½Ğ»Ğ°Ğ¹Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ğ²Ğ¾Ğ´ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° -->
        <div id="inlineDeviceForm" style="display:none; padding: 10px 15px;">
            <input id="inlineDeviceName" placeholder="è¾“å…¥è®¾å¤‡åç§°"
                style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;"
                onkeydown="handleDeviceEnter(event)">
        </div>
        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div id="device-submenu" class="submenu" id="device-submenu">
            {% for device in devices %}
            <div class="submenu-item" data-device-id="{{ device.id }}"
                style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-cog"></i>
                    <span class="device-name" data-id="{{ device.id }}" style="margin-left: 8px;">{{ device.name }}</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <a href="#" title="æ·»åŠ æ£€æµ‹ç‚¹" onclick="togglePointInlineForm({{ device.id }}); return false;"
                        style="margin-right: 1px;">
                        <i class="fas fa-circle-plus" data-toggle="point" style="font-size: 16px; color: #2196F3;"></i>
                    </a>
                    <a href="#" title="é‡å‘½åè®¾å¤‡" onclick="editDeviceName({{ device.id }}); return false;"
                        style="margin-right: 1px;">
                        <i class="fas fa-pen" style="font-size: 14px; color: #ffc107;"></i>
                    </a>
                    <a href="#" title="åˆ é™¤è®¾å¤‡" onclick="deleteDevice({{ device.id }}); return false;">
                        <i class="fas fa-trash" style="font-size: 16px; color: #f44336;"></i>
                    </a>
                </div>
            </div>
    
            <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ñ‡ĞµĞº -->
            <div class="detection-points show-on-load">
                <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ -->
                <div class="inline-point-form" id="pointFormFor{{ device.id }}" style="display: none; padding: 5px 20px;">
                    <input placeholder="è¾“å…¥æ£€æµ‹ç‚¹åç§°"
                        style="width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                        onkeydown="handlePointEnter(event, {{ device.id }})">
                </div>
        
                {% if device.points %}
                {% for point in device.points %}
                <div class="detection-point" style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="point-name" data-id="{{ point.id }}" data-type="device_point">{{ point.name }}</span>
                    <div style="display: flex; gap: 6px;">
                        <i class="fas fa-pen" onclick="editPointName({{ point.id }})"
                            style="font-size: 12px; color: #ffc107; cursor: pointer;margin-right: 4px;"></i>
                        <a href="#" title="åˆ é™¤ç›‘æµ‹ç‚¹" onclick="deletePoint({{ point.id }}); return false;">
                            <i class="fas fa-trash" style="font-size: 14px; color: #f44336;"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="detection-point" style="color: gray;">(æ— æ£€æµ‹ç‚¹)</div>
                {% endif %}
            </div>
            {% endfor %}
         </div>


        <div class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <i class="fas fa-flask"></i>
                    <span>æ²¹å“æ£€æµ‹ç®¡ç†</span>
                </div>
                <a href="#" title="æ·»åŠ æ²¹å“åˆ†ç±»" onclick="toggleOilCategoryInlineForm(); return false;">
                    <i class="fas fa-circle-plus" id="oilCategoryToggleIcon"
                        style="font-size: 18px; color: #4CAF50; margin-right: 10px;"></i>
                </a>
                
            </div>
            <!-- éšè—çš„è¾“å…¥æ¡† -->
            <div id="inlineOilCategoryForm" style="display:none; padding: 10px 15px;">
                <input id="inlineOilCategoryName" placeholder="è¾“å…¥åˆ†ç±»"
                    style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;"
                    onkeydown="handleOilCategoryEnter(event)">
            </div>
            
        <div id="oil-submenu" class="submenu" id="oil-submenu">
            {% for cat in oil_categories %}
                <div class="submenu-item" data-category-id="{{ cat.id }}"
                    style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-droplet"></i>
                        <span class="category-name" data-id="{{ cat.id }}" style="margin-left: 8px;">{{ cat.name }}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <a href="#" title="æ·»åŠ æ£€æµ‹ç‚¹" onclick="toggleOilPointInlineForm({{ cat.id }}); return false;"
                            style="margin-right: 4px;">
                            <i class="fas fa-circle-plus" style="font-size: 16px; color: #2196F3;"></i>
                        </a>
                        <a href="#" title="é‡å‘½ååˆ†ç±»" onclick="editOilCategoryName({{ cat.id }}); return false;"
                            style="margin-right: 4px;">
                            <i class="fas fa-pen" style="font-size: 14px; color: #ffc107;"></i>
                        </a>
                        <a href="#" title="åˆ é™¤åˆ†ç±»" onclick="deleteOilCategory({{ cat.id }}); return false;">
                            <i class="fas fa-trash" style="font-size: 16px; color: #f44336;"></i>
                        </a>
                </div>
            </div>
    
            <!-- æ£€æµ‹ç‚¹åˆ—è¡¨ -->
            <div class="detection-points show-on-load">
                <div class="inline-point-form" id="oilPointFormFor{{ cat.id }}" style="display: none; padding: 5px 20px;">
                    <input placeholder="è¾“å…¥å–æ ·ç‚¹åç§°"
                        style="width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                        onkeydown="handleOilPointEnter(event, {{ cat.id }})">
                </div>
        
                {% if cat.oils %}
                {% for point in cat.oils %}
                <div class="detection-point" style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="point-name" data-id="{{ point.id }}" data-type="oil_point">{{ point.name }}</span>
                    <i class="fas fa-pen" onclick="editOilPointName({{ point.id }})"
                        style="font-size: 12px; color: #ffc107; cursor: pointer;"></i>                
                        <a href="#" title="åˆ é™¤æ£€æµ‹ç‚¹" onclick="deleteOilPoint({{ point.id }}); return false;">
                            <i class="fas fa-trash" style="font-size: 14px; color: #f44336;"></i>
                        </a>
                </div>
                 {% endfor %}
                 {% else %}
                <div class="detection-point" style="color: gray;">(æ— å–æ ·ç‚¹)</div>
            {% endif %}
            </div>
             {% endfor %}
        </div>

        <div class="menu-item">
            <i class="fas fa-users"></i>
            <span>ç”¨æˆ·</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="selected-title-container">
            <div class="selected-title" id="selected-title">åˆé¦å¡” E-123A/Bå‡ºå£ç®¡çº¿</div>
            <div class="button-group">
                <a href="/rules" target="_blank">
                    <button class="rule-button">è§„åˆ™è¡¨</button>
                </a>
                  
                <button class="rule-button">å†å²æ¡ˆä¾‹è¡¨</button>
            </div>
        </div>
        <div class="button-container">
            <div class="left-buttons">
                <button class="primary-button" onclick="openAddMeasurementModal()">æ·»åŠ </button>

                <button class="primary-button">ä¿®æ”¹</button>
                <button class="primary-button">åˆ é™¤</button>
                <button class="primary-button">å¯¼å‡º</button>
                <button class="primary-button">æ‰“å°</button>
                <button class="primary-button">åˆ·æ–°</button>
            </div>
        </div>

        <div class="data-table-container">
            <div class="table-tabs">
                <div class="table-tab active">åŸå§‹æ•°æ®è¡¨</div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox"></th>
                        <th>å…¬ç§°åšåº¦ï¼ˆmmï¼‰</th>
                        <th>MOAPå…è®¸æœ€å°å£åšï¼ˆmmï¼‰</th>
                        <th>å®æµ‹åšåº¦ï¼ˆmmï¼‰</th>
                        <th>è…èš€é€Ÿç‡ï¼ˆmm/aï¼‰</th>
                        <th>æœ€å¤§å…è®¸è…èš€åšåº¦ï¼ˆmmï¼‰</th>
                        <th>æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    {% for m in device.measurements %}
                    <tr data-id="{{ m.id }}">
                        <td><input type="checkbox"></td>
                        <td>{{ m.nominal_thickness }}</td>
                        <td>{{ m.moap_min_thickness }}</td>
                        <td>{{ m.actual_thickness }}</td>
                        <td>{{ m.corrosion_rate }}</td>
                        <td>{{ m.max_corrosion_allowance }}</td>
                        <td>{{ m.timestamp.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>            
        </div>

        <div class="action-buttons">
            <button class="action-button" id="evaluate-button">è¯„ä»·</button>
            <button class="action-button" id="visualize-button">å¯è§†åŒ–</button>
            <button class="device-life-button" id="device-life-button">è®¾å¤‡ä½¿ç”¨å¯¿å‘½</button>
        </div>
    </div>
<!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ¾Ğ² -->
<div id="visualizationModal"
    style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:white; border:2px solid #3498db; border-radius:10px; z-index:9999; overflow:auto; padding:20px;">
    <h3>ğŸ“Š Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</h3>
    <label>ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°:</label>
    <input type="date" id="startDate">
    <label style="margin-left:10px;">ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°:</label>
    <input type="date" id="endDate">
    <button onclick="loadVisualization()" style="margin-left: 10px;">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>

    <div id="chart-thickness" style="width:100%; height:40%; margin-bottom: 30px;"></div>
    <div id="chart-corrosion" style="width:100%; height:40%;"></div>
    <button onclick="document.getElementById('visualizationModal').style.display='none'"
        style="margin-top:10px;">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
</div>

<!-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ -->
<div id="pointModal"
    style="display: none; position: fixed; top: 20%; left: 35%; width: 30%; background: white; border: 2px solid #2196F3; border-radius: 10px; z-index: 9999; padding: 20px;">
    <h3>â• æ·»åŠ æ£€æµ‹ç‚¹</h3>
    <form id="pointForm">
        <input name="name" placeholder="æ£€æµ‹ç‚¹åç§°" required style="width: 100%;"><br><br>
        <input type="hidden" name="device_id" id="pointDeviceId">
        <button type="submit">ä¿å­˜</button>
        <button type="button" onclick="closePointModal()">å–æ¶ˆ</button>
    </form>
</div>

<!-- æ·»åŠ æµ‹é‡è®°å½• -->
<div id="addMeasurementModal"
    style="display:none; position:fixed; top:20%; left:35%; width:30%; background:white; border:2px solid #2196F3; border-radius:10px; z-index:9999; padding:20px;">
    <h3>â• æ·»åŠ æµ‹é‡è®°å½•</h3>
    <form id="addMeasurementForm">
        <input type="hidden" name="point_id" id="currentPointIdInput">
        <label>å…¬ç§°åšåº¦:</label><input name="nominal_thickness" type="number" step="0.01" required><br><br>
        <label>MOAPå…è®¸æœ€å°å£åš:</label><input name="moap_min_thickness" type="number" step="0.01" required><br><br>
        <label>å®æµ‹åšåº¦:</label><input name="actual_thickness" type="number" step="0.01" required><br><br>
        <label>è…èš€é€Ÿç‡:</label><input name="corrosion_rate" type="number" step="0.01" required><br><br>
        <label>æœ€å¤§å…è®¸è…èš€åšåº¦:</label><input name="max_corrosion_allowance" type="number" step="0.01" required><br><br>
        <button type="submit">ä¿å­˜</button>
        <button type="button" onclick="closeAddMeasurementModal()">å–æ¶ˆ</button>
    </form>
</div>

<script>
    function openAddMeasurementModal() {
        if (!window.currentPointId) {
            alert("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›‘æµ‹ç‚¹");
            return;
        }
        document.getElementById('currentPointIdInput').value = window.currentPointId;
        document.getElementById('addMeasurementModal').style.display = 'block';
    }

    function closeAddMeasurementModal() {
        document.getElementById('addMeasurementModal').style.display = 'none';
    }

    document.getElementById('addMeasurementForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/add-measurement', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closeAddMeasurementModal();
                    alert("âœ… æ·»åŠ æˆåŠŸï¼");
                    const pointId = window.currentPointId;
                    fetch(`/api/data/device_point/${pointId}`)
                        .then(res => res.json())
                        .then(data => renderDataTable(data));
                } else {
                    alert("âŒ æ·»åŠ å¤±è´¥ï¼š" + data.message);
                }
            });
    });
</script>


<div id="toast"
    style="display:none; position:fixed; bottom:20px; right:20px; background:#4caf50; color:white; padding:10px 20px; border-radius:5px; z-index:9999;">
</div>

<!-- æ·»åŠ æµ‹é‡è®°å½• -->


<script>

    // åˆ‡æ¢è¡¨æ ¼æ ‡ç­¾
        document.querySelectorAll('.table-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.table-tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');

                const tabText = this.textContent;
                const dataTableContainer = document.querySelector('.data-table-container');
                if (tabText === 'ç¡«å«é‡ä¸é…¸å€¼æ•°æ®') {
                    dataTableContainer.innerHTML = `
                <div class="table-tabs">
                    <div class="table-tab active">ç¡«å«é‡ä¸é…¸å€¼æ•°æ®</div>
                    <div class="table-tab">ç›å«é‡æ•°æ®</div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>id</th>
                            <th>æ—¶é—´</th>
                            <th>ç¡«å«é‡ï¼ˆ%ï¼‰</th>
                            <th>é…¸å€¼ï¼ˆmgKOH/gï¼‰</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>2025-02-17 10:00:00</td>
                            <td>0.89</td>
                            <td>0.33</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>2025-02-24 10:00:00</td>
                            <td>0.64</td>
                            <td>0.42</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>2025-03-03 10:00:00</td>
                            <td>0.86</td>
                            <td>0.31</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>2025-03-10 10:00:00</td>
                            <td>0.76</td>
                            <td>0.30</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>2025-03-17 10:00:00</td>
                            <td>0.61</td>
                            <td>0.24</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>2025-03-24 10:00:00</td>
                            <td>0.70</td>
                            <td>0.34</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>2025-03-31 10:00:00</td>
                            <td>0.40</td>
                            <td>0.18</td>
                        </tr>
                    </tbody>
                </table>
            `;
                } else if (tabText === 'ç›å«é‡æ•°æ®') {
                    dataTableContainer.innerHTML = `
                <div class="table-tabs">
                    <div class="table-tab">ç¡«å«é‡ä¸é…¸å€¼æ•°æ®</div>
                    <div class="table-tab active">ç›å«é‡æ•°æ®</div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>id</th>
                            <th>æ—¶é—´</th>
                            <th>ç›å«é‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>2025-02-17 10:00:00</td>
                            <td>0.1</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>2025-02-24 10:00:00</td>
                            <td>0.12</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>2025-03-03 10:00:00</td>
                            <td>0.09</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>2025-03-10 10:00:00</td>
                            <td>0.11</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>2025-03-17 10:00:00</td>
                            <td>0.08</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>2025-03-24 10:00:00</td>
                            <td>0.13</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>2025-03-31 10:00:00</td>
                            <td>0.07</td>
                        </tr>
                    </tbody>
                </table>
            `;
                }
                addRowSelectionFunctionality(dataTableContainer);
            });
        });

        // èœå•é¡¹ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');

                // å¦‚æœç‚¹å‡»çš„æ˜¯"ç‚¼æ²¹è£…ç½®ç®¡ç†"æˆ–"æ²¹å“æ£€æµ‹ç®¡ç†"ï¼Œæ˜¾ç¤ºå­èœå•
                const menuItemText = this.querySelector('span').textContent;
                if (menuItemText === 'ç‚¼æ²¹è£…ç½®ç®¡ç†') {
                    const submenu = document.getElementById('device-submenu');
                    submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';

                    // æ˜¾ç¤ºè®¾å¤‡ä½¿ç”¨å¯¿å‘½æŒ‰é’®
                    document.getElementById('device-life-button').style.display = 'block';
                } else if (menuItemText === 'æ²¹å“æ£€æµ‹ç®¡ç†') {
                    const submenu = document.getElementById('oil-submenu');
                    submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';

                    // éšè—è®¾å¤‡ä½¿ç”¨å¯¿å‘½æŒ‰é’®
                    document.getElementById('device-life-button').style.display = 'none';

                    // æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜å’Œå†…å®¹
                    const dataTableContainer = document.querySelector('.data-table-container');
                    dataTableContainer.innerHTML = `
                <div class="table-tabs">
                    <div class="table-tab active">ç¡«å«é‡ä¸é…¸å€¼æ•°æ®</div>
                    <div class="table-tab">ç›å«é‡æ•°æ®</div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>id</th>
                            <th>æ—¶é—´</th>
                            <th>ç¡«å«é‡ï¼ˆ%ï¼‰</th>
                            <th>é…¸å€¼ï¼ˆmgKOH/gï¼‰</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>2025-02-17 10:00:00</td>
                            <td>0.89</td>
                            <td>0.33</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>2025-02-24 10:00:00</td>
                            <td>0.64</td>
                            <td>0.42</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>2025-03-03 10:00:00</td>
                            <td>0.86</td>
                            <td>0.31</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>2025-03-10 10:00:00</td>
                            <td>0.76</td>
                            <td>0.30</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>2025-03-17 10:00:00</td>
                            <td>0.61</td>
                            <td>0.24</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>2025-03-24 10:00:00</td>
                            <td>0.70</td>
                            <td>0.34</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>2025-03-31 10:00:00</td>
                            <td>0.40</td>
                            <td>0.18</td>
                        </tr>
                    </tbody>
                </table>
            `;
                    addRowSelectionFunctionality(dataTableContainer);
                }
            });
        });

        // æ£€æµ‹ç‚¹æ˜¾ç¤º/éšè—
        document.querySelectorAll('.submenu-item').forEach(item => {
            item.addEventListener('click', function (event) {
                event.stopPropagation();
                const parentMenuText = this.closest('.submenu').previousElementSibling.querySelector('span').textContent;
                let pointsId;

                if (parentMenuText === 'ç‚¼æ²¹è£…ç½®ç®¡ç†') {
                    const deviceName = this.querySelector('span').textContent;
                    switch (deviceName) {
                        case 'åˆé¦å¡”':
                            pointsId = 'e001-points';
                            break;
                        case 'å¸¸å‹å¡”':
                            pointsId = 'e002-points';
                            break;
                        case 'å‡å‹å¡”':
                            pointsId = 'e003-points';
                            break;
                        default:
                            return;
                    }
                } else if (parentMenuText === 'æ²¹å“æ£€æµ‹ç®¡ç†') {
                    const oilName = this.querySelector('span').textContent;
                    switch (oilName) {
                        case 'è¿›åˆé¦å¡”æ²¹å“':
                            pointsId = 'a001-points';
                            break;
                        case 'è¿›å¸¸å‹å¡”æ²¹å“':
                            pointsId = 'a002-points';
                            break;
                        case 'è¿›å‡å‹å¡”æ²¹å“':
                            pointsId = 'a003-points';
                            break;
                        default:
                            return;
                    }
                }

                const points = document.getElementById(pointsId);
                points.style.display = points.style.display === 'block' ? 'none' : 'block';
            });
        });

        // æ£€æµ‹ç‚¹ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.detection-point').forEach(point => {
            point.addEventListener('click', function (event) {
                event.stopPropagation();
                const parentElement = this.closest('.submenu');
                const parentMenuText = parentElement.previousElementSibling.querySelector('span').textContent;
                let titlePrefix;

                if (parentMenuText === 'ç‚¼æ²¹è£…ç½®ç®¡ç†') {
                    const deviceName = this.closest('.detection-points').previousElementSibling.querySelector('span').textContent;
                    titlePrefix = deviceName;
                } else if (parentMenuText === 'æ²¹å“æ£€æµ‹ç®¡ç†') {
                    const oilName = this.closest('.detection-points').previousElementSibling.querySelector('span').textContent;
                    titlePrefix = oilName;
                }

                // ç§»é™¤æ‰€æœ‰æ£€æµ‹ç‚¹çš„activeç±»
                document.querySelectorAll('.detection-point').forEach(p => {
                    p.classList.remove('active');
                });
                // ä¸ºå½“å‰ç‚¹å‡»çš„æ£€æµ‹ç‚¹æ·»åŠ activeç±»
                this.classList.add('active');

                const pointName = this.textContent;
                document.getElementById('selected-title').textContent = `${titlePrefix} ${pointName}`;
            });
        });

        // ç‚¹å‡»ä¸»å†…å®¹åŒºåŸŸæ—¶ä¸éšè—å­èœå•
        document.querySelector('.main-content').addEventListener('click', function (event) {
            // ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œé˜²æ­¢éšè—å­èœå•
        });

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        document.querySelector('thead input[type="checkbox"]').addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('tbody input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = checked;
            });
        });

        // æ·»åŠ è¡Œé€‰æ‹©åŠŸèƒ½
        function addRowSelectionFunctionality(container) {
            const table = container.querySelector('.data-table');
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                let lastSelectedRow = null;

                rows.forEach(row => {
                    row.addEventListener('click', function (event) {
                        if (event.ctrlKey) {
                            // Ctrl é”®æŒ‰ä¸‹ï¼Œåˆ‡æ¢å½“å‰è¡Œçš„é€‰ä¸­çŠ¶æ€
                            this.classList.toggle('selected');
                        } else if (event.shiftKey && lastSelectedRow) {
                            // Shift é”®æŒ‰ä¸‹ï¼Œé€‰æ‹©è¿ç»­çš„è¡Œ
                            const startIndex = Array.from(rows).indexOf(lastSelectedRow);
                            const endIndex = Array.from(rows).indexOf(this);
                            const minIndex = Math.min(startIndex, endIndex);
                            const maxIndex = Math.max(startIndex, endIndex);
                            for (let i = minIndex; i <= maxIndex; i++) {
                                rows[i].classList.add('selected');
                            }
                        } else {
                            // æ— ä¿®é¥°é”®ï¼Œåªé€‰æ‹©å½“å‰è¡Œ
                            rows.forEach(r => r.classList.remove('selected'));
                            this.classList.add('selected');
                        }
                        lastSelectedRow = this;
                        updateButtonState(rows);
                    });
                });
            }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState(rows) {
            const selectedRows = Array.from(rows).filter(row => row.classList.contains('selected'));
            const evaluateButton = document.getElementById('evaluate-button');
            const visualizeButton = document.getElementById('visualize-button');

            if (selectedRows.length === 1) {
                evaluateButton.disabled = false;
                visualizeButton.disabled = true;
            } else if (selectedRows.length > 1) {
                evaluateButton.disabled = true;
                visualizeButton.disabled = false;
            } else {
                evaluateButton.disabled = true;
                visualizeButton.disabled = true;
            }
        }

        // åˆå§‹æ·»åŠ è¡Œé€‰æ‹©åŠŸèƒ½
        const dataTableContainer = document.querySelector('.data-table-container');
        addRowSelectionFunctionality(dataTableContainer);

        // åˆå§‹ç¦ç”¨æŒ‰é’®
        const evaluateButton = document.getElementById('evaluate-button');
        const visualizeButton = document.getElementById('visualize-button');
        evaluateButton.disabled = true;
        visualizeButton.disabled = true;

        // === ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞÑ†ĞµĞ½Ğ¸Ñ‚ÑŒ"
        document.getElementById('evaluate-button').addEventListener('click', function () {
            const selectedRow = document.querySelector('.data-table tr.selected');
            if (!selectedRow) {
                alert("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ¾ĞºÑƒ.");
                return;
            }
            const id = selectedRow.getAttribute('data-id');
            fetch(`/evaluate/${id}`)
                .then(res => res.text())
                .then(result => {
                    alert(result);
                })
                .catch(err => {
                    alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….");
                    console.error(err);
                });
        });

        // Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ visualize - button 
        document.getElementById('visualize-button').addEventListener('click', function () {
            document.getElementById('visualizationModal').style.display = 'block';
            loadVisualization(); // Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸
        });

        function loadVisualization() {
            const selectedRows = document.querySelectorAll('.data-table tr.selected');
            const ids = Array.from(selectedRows).map(row => row.getAttribute('data-id'));

            if (ids.length < 1) {
                alert("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ¾Ğ´Ğ½Ñƒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ.");
                return;
            }

            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            fetch('/visualize-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids, start_date: start, end_date: end })
            })
                .then(res => res.json())
                .then(data => {
                    const chart1 = echarts.init(document.getElementById('chart-thickness'));
                    chart1.setOption({
                        title: { text: 'Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ñ‹' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: data.timestamps },
                        yAxis: { type: 'value', name: 'Ğ¢Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ° (Ğ¼Ğ¼)' },
                        series: [{ name: 'Ğ¢Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ°', type: 'line', data: data.thickness }]
                    });

                    const chart2 = echarts.init(document.getElementById('chart-corrosion'));
                    chart2.setOption({
                        title: { text: 'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ñ€Ñ€Ğ¾Ğ·Ğ¸Ğ¸' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: data.timestamps },
                        yAxis: { type: 'value', name: 'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ (Ğ¼Ğ¼/Ğ³Ğ¾Ğ´)' },
                        series: [{ name: 'ĞšĞ¾Ñ€Ñ€Ğ¾Ğ·Ğ¸Ñ', type: 'line', data: data.corrosion }]
                    });
                })
                .catch(err => {
                    alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….");
                    console.error(err);
                });
        }

        // Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ detection-points Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ¼ show-on-load
        document.querySelectorAll('.detection-points.show-on-load').forEach(p => {
            p.style.display = 'block';
        });

        // JS - Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ / Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
        function openDeviceModal() {
            document.getElementById('deviceModal').style.display = 'block';
        }
        function closeDeviceModal() {
            document.getElementById('deviceModal').style.display = 'none';
        }
        function openPointModal(deviceId) {
            document.getElementById('pointDeviceId').value = deviceId;
            document.getElementById('pointModal').style.display = 'block';
        }

        function closePointModal() {
            document.getElementById('pointModal').style.display = 'none';
        }

        document.getElementById('pointForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/add-point-ajax', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        closePointModal();
                        const pointName = document.querySelector('#pointForm input[name="name"]').value;
                        const deviceId = document.getElementById('pointDeviceId').value;

                        // Ğ’ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² DOM
                        const container = document.querySelector(`.submenu-item[data-device-id="${deviceId}"] + .detection-points`);
                        const newPoint = document.createElement('div');
                        newPoint.className = 'detection-point';
                        newPoint.innerHTML = `${pointName} <a href="#">è§„åˆ™è¡¨</a>`;
                        container.appendChild(newPoint);

                        document.getElementById('pointForm').reset();
                        showToast("âœ… æ£€æµ‹ç‚¹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!");
                    } else {
                        showToast("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ.");
                    }
                });
        });

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2000);
        }

        //JS Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ñ‡ĞµÑ€ĞµĞ· fetch()
        document.getElementById('deviceForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/add-device-ajax', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("âœ… Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!");
                        location.reload();  // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
                    } else {
                        alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ.");
                    }
                });
        });

        function openDeviceInlineForm() {
            document.getElementById('inlineDeviceForm').style.display = 'block';
        }

        function submitInlineDevice() {
            const name = document.getElementById('inlineDeviceName').value.trim();
            const type = document.getElementById('inlineDeviceType').value.trim();
            if (!name || !type) {
                showToast("âš ï¸ è¯·å¡«å†™åç§°å’Œç±»å‹ï¼");
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('type', type);

            fetch('/add-device-ajax', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… è®¾å¤‡æ·»åŠ æˆåŠŸï¼");
                        location.reload();
                    } else {
                        showToast("âŒ æ·»åŠ å¤±è´¥ï¼");
                    }
                });
        }

        function openDeviceInlineForm() {
            const input = document.getElementById('inlineDeviceForm');
            const icon = document.querySelector('i[data-toggle="device"]');
            const visible = input.style.display === 'block';

            input.style.display = visible ? 'none' : 'block';

            if (!visible) {
                document.getElementById('inlineDeviceName').focus();
            }

            // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ
            if (icon) {
                icon.classList.remove('fa-circle-plus', 'fa-circle-minus');
                icon.classList.add(visible ? 'fa-circle-plus' : 'fa-circle-minus');
            }
        }


        function handleDeviceEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();  // ğŸš« Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½ÑƒÑ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ Ñ„Ğ¾Ñ€Ğ¼Ñ‹
                submitInlineDevice();
            }
        }

        function submitInlineDevice() {
            const name = document.getElementById('inlineDeviceName').value.trim();
            if (!name) return;

            const formData = new FormData();
            formData.append('name', name);

            fetch('/add-device-ajax', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… è®¾å¤‡æ·»åŠ æˆåŠŸï¼");
                        location.reload();  // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ²ÑÑ‚Ğ°Ğ²ĞºÑƒ DOM
                    } else {
                        showToast("âŒ æ·»åŠ å¤±è´¥ï¼");
                    }
                });
        }




        function togglePointInlineForm(deviceId) {
            const form = document.getElementById('pointFormFor' + deviceId);
            const toggleIcon = document.querySelector(`.submenu-item[data-device-id="${deviceId}"] i[data-toggle="point"]`);
            const visible = form.style.display === 'block';

            // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ñ‹
            form.style.display = visible ? 'none' : 'block';
            if (!visible) {
                form.querySelector('input').focus();
            }

            // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸
            if (toggleIcon) {
                toggleIcon.classList.remove('fa-circle-plus', 'fa-circle-minus');
                toggleIcon.classList.add(visible ? 'fa-circle-plus' : 'fa-circle-minus');
            }
        }


        function handlePointEnter(event, deviceId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitInlinePoint(deviceId);
            }
        }

        function submitInlinePoint(deviceId) {
            const form = document.getElementById('pointFormFor' + deviceId);
            const input = form.querySelector('input');
            const name = input.value.trim();
            if (!name) return;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('device_id', deviceId);

            fetch('/add-point-ajax', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… æ£€æµ‹ç‚¹æ·»åŠ æˆåŠŸï¼");
                        input.value = '';
                        form.style.display = 'none';

                        // ğŸ”§ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ² DOM
                        const container = document.querySelector(`.submenu-item[data-device-id="${deviceId}"] + .detection-points`);
                        const newPoint = document.createElement('div');
                        newPoint.className = 'detection-point';
                        newPoint.innerHTML = `${name} <a href="/rules/${data.point_id}" target="_blank">è§„åˆ™è¡¨</a>`;
                        container.appendChild(newPoint);
                    } else {
                        showToast("âŒ æ·»åŠ å¤±è´¥ï¼");
                    }
                });
        }


        document.addEventListener('click', function (event) {
            console.log("ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñƒ:", event.target);

            const target = event.target;

            const inlineDeviceForm = document.getElementById('inlineDeviceForm');
            const isClickInsideDevice = inlineDeviceForm.contains(target);
            const isClickDeviceToggle = target.closest('[data-toggle="device"]');

            console.log("â†’ isClickInsideDevice:", isClickInsideDevice);
            console.log("â†’ isClickDeviceToggle:", isClickDeviceToggle);

            if (!isClickInsideDevice && !isClickDeviceToggle && inlineDeviceForm.style.display === 'block') {
                console.log("âœ… Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ inlineDeviceForm");
                inlineDeviceForm.style.display = 'none';
            }

            document.querySelectorAll('.inline-point-form').forEach(form => {
                const isClickInsidePoint = form.contains(target);
                const isClickPointToggle = target.closest('[data-toggle="point"]');

                console.log("â†’ isClickInsidePoint:", isClickInsidePoint);
                console.log("â†’ isClickPointToggle:", isClickPointToggle);

                if (!isClickInsidePoint && !isClickPointToggle && form.style.display === 'block') {
                    console.log("âœ… Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ point form:", form.id);
                    form.style.display = 'none';
                }
            });
        });

        function deleteDevice(id) {
            if (!confirm("âš ï¸ åˆ é™¤è®¾å¤‡å°†åŒæ—¶åˆ é™¤å…¶ä¸‹æ‰€æœ‰ç›‘æµ‹ç‚¹ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")) return;

            fetch(`/delete-device/${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… è®¾å¤‡å·²åˆ é™¤ï¼");
                        location.reload();
                    } else {
                        alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + data.message);
                    }
                });
        }

        function deletePoint(id) {
            if (!confirm("ç¡®è®¤åˆ é™¤æ­¤ç›‘æµ‹ç‚¹ï¼Ÿ")) return;

            fetch(`/delete-point/${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… æ£€æµ‹ç‚¹å·²åˆ é™¤ï¼");
                        location.reload();
                    } else {
                        alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + data.message);
                    }
                });
        }

        function editDeviceName(id) {
            const span = document.querySelector(`.device-name[data-id="${id}"]`);
            const oldName = span.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.style.width = '120px';

            span.replaceWith(input);
            input.focus();

            input.addEventListener('blur', function () {
                const newName = input.value.trim();
                fetch(`/rename-device/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                })
                    .then(res => res.json())
                    .then(data => {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'device-name';
                        newSpan.dataset.id = id;
                        newSpan.textContent = newName || oldName;
                        input.replaceWith(newSpan);
                    });
            });

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }


        function editPointName(id) {
            const span = document.querySelector(`.point-name[data-id="${id}"]`);
            const oldName = span.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.style.width = '120px';

            span.replaceWith(input);
            input.focus();

            input.addEventListener('blur', function () {
                const newName = input.value.trim();
                fetch(`/rename-point/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                })
                    .then(res => res.json())
                    .then(data => {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'point-name';
                        newSpan.dataset.id = id;
                        newSpan.textContent = newName || oldName;
                        input.replaceWith(newSpan);
                    });
            });

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        const span = this.querySelector('.point-name');
        const pointId = span.dataset.id;
        const pointType = span.dataset.type;

        window.currentPointId = pointId;
        window.currentPointType = pointType;

        document.getElementById('selected-title').textContent = `å½“å‰é€‰æ‹©ï¼š${span.textContent}`;



        document.querySelectorAll('.detection-point').forEach(point => {
            point.addEventListener('click', function () {
                document.querySelectorAll('.detection-point').forEach(p => p.classList.remove('active'));
                this.classList.add('active');

                const span = this.querySelector('.point-name');
                const pointId = span.dataset.id;
                const pointType = span.dataset.type;

                window.currentPointId = pointId;
                window.currentPointType = pointType;

                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº
                document.getElementById('selected-title').textContent = `å½“å‰é€‰æ‹©ï¼š${span.textContent}`;

                // ğŸ‘‰ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
                fetch(`/api/data/${pointType}/${pointId}`)
                    .then(res => res.json())
                    .then(data => renderDataTable(data))
                    .catch(err => {
                        console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', err);
                    });
            });
        });


        function renderDataTable(data) {
            const container = document.querySelector('.data-table-container');
            if (data.length === 0) {
                container.innerHTML = "<p style='padding:20px;'>æš‚æ— æ•°æ®ã€‚</p>";
                return;
            }

            const rowsHtml = data.map(row => `
                        <tr data-id="${row.id}">
                            <td>${row.nominal_thickness}</td>
                            <td>${row.moap_min_thickness}</td>
                            <td>${row.actual_thickness}</td>
                            <td>${row.corrosion_rate}</td>
                            <td>${row.max_corrosion_allowance}</td>
                            <td>${row.timestamp}</td>
                        </tr>
                    `).join('');

            container.innerHTML = `
                        <div class="table-tabs">
                            <div class="table-tab active">åŸå§‹æ•°æ®è¡¨</div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å…¬ç§°åšåº¦ï¼ˆmmï¼‰</th>
                                    <th>MOAPå…è®¸æœ€å°å£åšï¼ˆmmï¼‰</th>
                                    <th>å®æµ‹åšåº¦ï¼ˆmmï¼‰</th>
                                    <th>è…èš€é€Ÿç‡ï¼ˆmm/aï¼‰</th>
                                    <th>æœ€å¤§å…è®¸è…èš€åšåº¦ï¼ˆmmï¼‰</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                    `;
        }



        function openAddMeasurementModal() {
            if (!window.currentPointId) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›‘æµ‹ç‚¹");
                return;
            }
            document.getElementById('currentPointIdInput').value = window.currentPointId;
            document.getElementById('addMeasurementModal').style.display = 'block';
        }

        function closeMeasurementModal() {
            document.getElementById('addMeasurementModal').style.display = 'none';
        }


        document.getElementById('addMeasurementForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/add-measurement', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        closeMeasurementModal();
                        showToast("âœ… æ·»åŠ æˆåŠŸï¼");
                        // è‡ªåŠ¨åˆ·æ–°æ•°æ®è¡¨
                        fetch(`/api/data/device_point/${window.currentPointId}`)
                            .then(res => res.json())
                            .then(data => renderDataTable(data));
                    } else {
                        alert("æ·»åŠ å¤±è´¥");
                    }
                });
        });


        document.querySelectorAll('.detection-point').forEach(point => {
            point.addEventListener('click', function () {
                // 1. Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ²ÑĞµÑ… .active
                document.querySelectorAll('.detection-point').forEach(p => p.classList.remove('active'));
                this.classList.add('active');

                // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ span Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ .point-name
                const span = this.querySelector('.point-name');
                if (!span) {
                    console.warn("âš ï¸ .point-name Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ñ‚Ğ¾Ñ‡ĞºĞµ");
                    return;
                }

                const pointId = span.dataset.id;
                const pointType = span.dataset.type;

                if (!pointId || !pointType) {
                    console.warn("âš ï¸ pointId Ğ¸Ğ»Ğ¸ pointType Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚:", span);
                    return;
                }

                // 3. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
                window.currentPointId = pointId;
                window.currentPointType = pointType;

                // 4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº
                document.getElementById('selected-title').textContent = `å½“å‰é€‰æ‹©ï¼š${span.textContent}`;

                // 5. Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
                console.log("âœ… é€‰æ‹©ç‚¹:", pointId, pointType);

                // 6. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒæ•°æ®
                fetch(`/api/data/${pointType}/${pointId}`)
                    .then(res => res.json())
                    .then(data => {
                        console.log("ğŸ“Š æ¥æ”¶åˆ°æ•°æ®:", data);
                        renderDataTable(data);
                    })
                    .catch(err => {
                        console.error("âŒ åŠ è½½æ•°æ®å¤±è´¥:", err);
                    });
            });
        });

        document.addEventListener('click', function (e) {
            const dp = e.target.closest('.detection-point');
            if (!dp) return;

            const span = dp.querySelector('.point-name');
            if (!span) {
                console.warn("âš ï¸ .point-name ä¸å­˜åœ¨");
                return;
            }

            const pointId = span.dataset.id;
            const pointType = span.dataset.type;

            if (!pointId || !pointType) {
                console.warn("âš ï¸ pointId æˆ– pointType ç¼ºå¤±");
                return;
            }

            window.currentPointId = pointId;
            window.currentPointType = pointType;

            // é«˜äº®é€‰ä¸­
            document.querySelectorAll('.detection-point').forEach(p => p.classList.remove('active'));
            dp.classList.add('active');

            // æ›´æ–°æ ‡é¢˜
            const titleEl = document.getElementById('selected-title');
            if (titleEl) titleEl.textContent = `å½“å‰é€‰æ‹©ï¼š${span.textContent}`;

            console.log("âœ… å½“å‰ç‚¹:", pointId, pointType);

            // åŠ è½½æ•°æ®
            fetch(`/api/data/${pointType}/${pointId}`)
                .then(res => res.json())
                .then(data => renderDataTable(data))
                .catch(err => console.error("âŒ æ•°æ®åŠ è½½å¤±è´¥:", err));
        });

        function openAddMeasurementModal() {
            console.log('window.currentPointId:', window.currentPointId);
            if (!window.currentPointId) {
                alert("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›‘æµ‹ç‚¹");
                return;
            }
            document.getElementById('currentPointIdInput').value = window.currentPointId;
            document.getElementById('addMeasurementModal').style.display = 'block';
        }

</script>
<script>
    
        function addOilPoint(categoryId) {
            const input = document.querySelector(`#oilPointFormFor${categoryId} input`);
            const name = input.value.trim();
            if (!name) return;

            fetch('/oil/add-point', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, name })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("æ·»åŠ å¤±è´¥");
                });
        }

        function deleteOilCategory(id) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥åˆ†ç±»å—ï¼Ÿå…¶ä¸­æ‰€æœ‰æµ‹ç‚¹ä¹Ÿå°†è¢«åˆ é™¤")) return;
            fetch(`/oil/delete-category/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("åˆ é™¤å¤±è´¥");
                });
        }

        function deleteOilPoint(id) {
            if (!confirm("Delete this æµ‹ç‚¹?")) return;
            fetch(`/oil/delete-point/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("Delete failed");
                });
        }

        function editOilCategoryName(id) {
            const span = document.querySelector(`.category-name[data-id='${id}']`);
            const currentName = span.textContent.trim();
            const newName = prompt("è¾“å…¥æ–°åç§°", currentName);
            if (!newName || newName === currentName) return;

            fetch(`/oil/rename-category/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("Rename failed");
                });
        }

        function editOilPointName(id) {
            const span = document.querySelector(`.point-name[data-id='${id}']`);
            const currentName = span.textContent.trim();
            const newName = prompt("è¾“å…¥æ–°åç§°", currentName);
            if (!newName || newName === currentName) return;

            fetch(`/oil/rename-point/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("Rename failed");
                });
        }

        function toggleOilPointInlineForm(categoryId) {
            const form = document.getElementById(`oilPointFormFor${categoryId}`);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
            if (form.style.display === 'block') form.querySelector('input').focus();
        }

        function handleOilPointEnter(event, categoryId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addOilPoint(categoryId);
            }
        }

        function openOilCategoryInlineForm() {
            const form = document.getElementById('inlineOilCategoryForm');
            form.style.display = 'block';
            document.getElementById('inlineOilCategoryName').focus();
        }

        function handleOilCategoryEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const name = document.getElementById('inlineOilCategoryName').value.trim();
                if (!name) return;

                const formData = new FormData();
                formData.append('name', name);

                fetch('/add-oil-category', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast("âœ… åˆ†ç±»æ·»åŠ æˆåŠŸï¼");
                            location.reload();
                        } else {
                            showToast("âŒ æ·»åŠ å¤±è´¥ï¼");
                        }
                    });
            }
        }

        function toggleOilPointInlineForm(categoryId) {
            const form = document.getElementById('oilPointFormFor' + categoryId);
            const icon = document.querySelector(`.submenu-item[data-category-id="${categoryId}"] i.fa-circle-plus, .submenu-item[data-category-id="${categoryId}"] i.fa-circle-minus`);

            const visible = form.style.display === 'block';
            form.style.display = visible ? 'none' : 'block';

            if (icon) {
                if (visible) {
                    icon.classList.remove('fa-circle-minus');
                    icon.classList.add('fa-circle-plus');
                } else {
                    icon.classList.remove('fa-circle-plus');
                    icon.classList.add('fa-circle-minus');
                }
            }

            if (!visible) {
                form.querySelector('input').focus();
            }
        }

        function toggleOilCategoryInlineForm() {
            const form = document.getElementById('inlineOilCategoryForm');
            const icon = document.getElementById('oilCategoryToggleIcon');

            const visible = form.style.display === 'block';
            form.style.display = visible ? 'none' : 'block';

            if (icon) {
                icon.classList.toggle('fa-circle-plus', visible);
                icon.classList.toggle('fa-circle-minus', !visible);
            }

            if (!visible) {
                document.getElementById('inlineOilCategoryName').focus();
            }
        }


        function handleOilPointEnter(event, categoryId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitOilPoint(categoryId);
            }
        }

        function submitOilPoint(categoryId) {
            const form = document.getElementById('oilPointFormFor' + categoryId);
            const input = form.querySelector('input');
            const name = input.value.trim();
            if (!name) return;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('category_id', categoryId);

            fetch('/add-oil-point', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… æ£€æµ‹ç‚¹æ·»åŠ æˆåŠŸï¼");
                        location.reload();  // Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² DOM
                    } else {
                        showToast("âŒ æ·»åŠ å¤±è´¥ï¼");
                    }
                });
        }

        function deleteOilPoint(id) {
            if (!confirm("ç¡®è®¤åˆ é™¤è¯¥æ£€æµ‹ç‚¹ï¼Ÿ")) return;

            fetch(`/delete-oil-point/${id}`, {
                method: 'POST'
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast("âœ… æ£€æµ‹ç‚¹å·²åˆ é™¤");
                        location.reload();
                    } else {
                        showToast("âŒ åˆ é™¤å¤±è´¥");
                    }
                });
        }

        function editOilPointName(id) {
            const span = document.querySelector(`.point-name[data-id="${id}"]`);
            const oldName = span.textContent;

            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.style = 'width: 60%; padding: 2px;';
            span.replaceWith(input);
            input.focus();

            function editOilCategoryName(id) {
                const span = document.querySelector(`.category-name[data-id='${id}']`);
                const input = document.querySelector(`.category-edit-input[data-id='${id}']`);

                span.style.display = 'none';
                input.style.display = 'inline-block';
                input.focus();

                input.addEventListener('keydown', function handler(e) {
                    if (e.key === 'Enter') {
                        const newName = input.value.trim();
                        if (!newName) return;

                        fetch(`/rename-oil-category/${id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    span.textContent = newName;
                                    span.style.display = 'inline-block';
                                    input.style.display = 'none';
                                }
                            });

                        input.removeEventListener('keydown', handler);
                    }

                    if (e.key === 'Escape') {
                        input.style.display = 'none';
                        span.style.display = 'inline-block';
                        input.removeEventListener('keydown', handler);
                    }
                });
            }



            input.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    const newName = input.value.trim();
                    if (!newName) return;

                    fetch(`/rename-oil-point/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                const newSpan = document.createElement('span');
                                newSpan.className = 'point-name';
                                newSpan.setAttribute('data-id', id);
                                newSpan.textContent = newName;
                                input.replaceWith(newSpan);
                                showToast("âœ… ä¿®æ”¹æˆåŠŸï¼");
                            } else {
                                showToast("âŒ ä¿®æ”¹å¤±è´¥ï¼");
                            }
                        });
                }
            });
        }

        function editOilCategoryName(id) {
            const span = document.querySelector(`.category-name[data-id="${id}"]`);
            const oldName = span.textContent;

            // ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
            const input = document.createElement("input");
            input.type = "text";
            input.value = oldName;
            input.style.width = "120px";
            input.style.padding = "2px";
            input.style.border = "1px solid #ccc";
            input.style.borderRadius = "4px";

            // Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ span Ğ½Ğ° input
            span.parentNode.replaceChild(input, span);
            input.focus();

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    const newName = input.value.trim();
                    if (!newName) return;

                    fetch(`/rename-oil-category/${id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ name: newName })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                const newSpan = document.createElement("span");
                                newSpan.className = "category-name";
                                newSpan.dataset.id = id;
                                newSpan.textContent = newName;
                                input.parentNode.replaceChild(newSpan, input);
                                showToast("âœ… é‡å‘½åæˆåŠŸï¼");
                            } else {
                                showToast("âŒ é‡å‘½åå¤±è´¥ï¼");
                            }
                        });
                }
                if (e.key === "Escape") {
                    // ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
                    input.parentNode.replaceChild(span, input);
                }
            });
        }

</script>
    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script>
    document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const title = item.innerText.trim();

                // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ° submenu
                document.getElementById('device-submenu').style.display = 'none';
                document.getElementById('oil-submenu').style.display = 'none';

                // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹
                if (title.includes('ç‚¼æ²¹è£…ç½®ç®¡ç†')) {
                    document.getElementById('device-submenu').style.display = 'block';
                } else if (title.includes('æ²¹å“æ£€æµ‹ç®¡ç†')) {
                    document.getElementById('oil-submenu').style.display = 'block';
                }

                // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾ Ğ²ÑĞµÑ…
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                item.classList.add('active');
            });
        });
        document.querySelectorAll('.submenu-item').forEach(item => {
            item.addEventListener('click', function () {
                // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ±Ğ»Ğ¾ĞºĞ¸ Ñæ£€æµ‹ç‚¹
                document.querySelectorAll('.detection-points').forEach(block => {
                    block.style.display = 'none';
                });

                // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ»Ğ¸ĞºĞ½ÑƒÑ‚Ğ¾Ğ³Ğ¾ submenu-item
                const next = this.nextElementSibling;
                if (next && next.classList.contains('detection-points')) {
                    next.style.display = 'block';
                }
            });
        });
    // åˆå§‹åŒ–äº‹ä»¶ç»‘å®š
        document.querySelectorAll('.detection-point').forEach(point => {
            point.addEventListener('click', function () {
                // ç§»é™¤æ‰€æœ‰ .active ç±»
                document.querySelectorAll('.detection-point').forEach(p => {
                    p.classList.remove('active');
                });

                // å½“å‰ç‚¹å‡»æ·»åŠ  .active ç±»
                this.classList.add('active');

                // æ›´æ–°å³ä¾§æ ‡é¢˜æˆ–ä¸»å†…å®¹åŒº
                const pointName = this.textContent.trim();
                document.getElementById('selected-title').textContent = pointName;
            });
        });
</script>

</body>

</html>